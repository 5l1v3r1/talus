#!/bin/bash

sudo mkdir -p /talus/data /var/log/talus/{apache2}

mkdir -p /tmp/talus/tmp
chown -R o+rws /tmp/talus/tmp

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

sudo apt-get install -y \
	libvirt-bin \
	qemu-kvm \
	virtinst \
	python-libvirt \
	qemu-utils \
	libxslt-dev \
	libxml2-dev \
	libvirt-dev \
	libffi-dev \
	build-essential \
	ruby-dev \
	python-pip \
	python-dev \
	wget

mkdir -p /tmp/vagrant_install \
	&& cd /tmp/vagrant_install \
	&& wget https://dl.bintray.com/mitchellh/vagrant/vagrant_1.7.2_x86_64.deb \
	&& sudo dpkg -i vagrant_1.7.2_x86_64.deb \
	&& rm -rf /tmp/vagrant_install

vagrant plugin install vagrant-libvirt
sudo pip install xmltodict mongoengine mock pymongo==2.8.0 sh pika docutils netifaces

cat << EOF > /tmp/talus_master.conf
description "Talus Master Daemon"
author		"Optiv Labs"

start on filesystem or runlevel [2345]
stop on shutdown
respawn

script
	$(readlink -f $DIR)/start_raw 2>&1 >> /var/log/talus/master.log
end script
EOF

sudo mv /tmp/talus_master.conf /etc/init/

$DIR/init_repo
